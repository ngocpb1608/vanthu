{% extends "base.html" %}
{% block content %}

<!-- Thá»‘ng kÃª tráº¡ng thÃ¡i (2 tháº») â€” ÄÆ¯A LÃŠN TRÃŠN -->
<div class="section" style="background:#e8faf7">
  <span class="icon" style="background:#d1fae5;color:#065f46">ğŸ“Š</span>
  Thá»‘ng kÃª theo tÃ¬nh tráº¡ng
</div>
<div class="grid md:grid-cols-2 gap-4 mb-6">
  <div class="stat stat-teal">
    <div class="font-extrabold mb-1">NV chÆ°a láº¥y</div>
    <div class="text-sm text-gray-600">{{ chua_lay|length }} há»“ sÆ¡</div>
  </div>
  <div class="stat stat-amber">
    <div class="font-extrabold mb-1">Äang giáº£i quyáº¿t</div>
    <div class="text-sm text-gray-600">{{ dang_giai_quyet|length }} há»“ sÆ¡</div>
  </div>
</div>

<!-- HoÃ n thÃ nh theo Loáº¡i Ä‘Æ¡n thÆ° (thÃ¡ng gáº§n nháº¥t) -->
<div class="section">
  <span class="icon">ğŸ—‚ï¸</span> HoÃ n thÃ nh theo Loáº¡i Ä‘Æ¡n thÆ°
</div>
<div class="card p-5 mb-6">
  <div class="mb-3 text-sm text-gray-600">
    {% if latest_thang and latest_nam %} ThÃ¡ng {{ '%02d'|format(latest_thang) }}/{{ latest_nam }} {% else %} ChÆ°a cÃ³ dá»¯ liá»‡u {% endif %}
  </div>
  <div class="overflow-x-auto rounded-lg border">
    <table class="min-w-full text-sm">
      <thead class="th">
        <tr>
          <th class="text-left px-3 py-2">Loáº¡i Ä‘Æ¡n thÆ°</th>
        <th class="text-right px-3 py-2">Sá»‘ lÆ°á»£ng</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% if hoan_thanh_by_loai %}
          {% for loai, cnt in hoan_thanh_by_loai %}
          <tr class="odd:bg-white even:bg-gray-50">
            <td class="px-3 py-2">{{ loai }}</td>
            <td class="px-3 py-2 text-right font-semibold">{{ cnt }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td class="px-3 py-2" colspan="2">KhÃ´ng cÃ³ dá»¯ liá»‡u.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- TÃ¬m kiáº¿m (Ä‘Æ°á»£c Ä‘Æ°a xuá»‘ng dÆ°á»›i) -->
<div class="section"><span class="icon">ğŸ”</span> TÃ¬m kiáº¿m cÃ´ng vÄƒn</div>
<div class="card p-5 mb-6">
  <form method="get" action="{{ url_for('dashboard') }}" class="space-y-3">
    <div class="grid md:grid-cols-5 gap-3">
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-600 mb-1">TÃªn KH</label>
        <input class="input" name="ten" placeholder="Nháº­p tÃªn..." value="{{ request.args.get('ten','') }}">
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">MÃ£ KH</label>
        <input class="input" name="ma_kh" placeholder="Nháº­p mÃ£..." value="{{ request.args.get('ma_kh','') }}">
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">ThÃ¡ng</label>
        <input class="input" type="number" min="1" max="12" name="thang" value="{{ request.args.get('thang','') }}">
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">NÄƒm</label>
        <input class="input" type="number" name="nam" value="{{ request.args.get('nam','') }}">
      </div>
    </div>

    <div class="grid md:grid-cols-5 gap-3">
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-600 mb-1">Äá»‹a chá»‰</label>
        <input class="input" name="dia_chi" value="{{ request.args.get('dia_chi','') }}">
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-600 mb-1">Loáº¡i Ä‘Æ¡n thÆ°</label>
        <select class="select" name="loai">
          <option value="">â€” Táº¥t cáº£ â€”</option>
          <option value="__EMPTY__" {% if request.args.get('loai')=='__EMPTY__' %}selected{% endif %}>(Trá»‘ng)</option>
          {% for opt in loai_options %}
            <option value="{{ opt }}" {% if request.args.get('loai')==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">TÃ¬nh tráº¡ng</label>
        <select class="select" name="tinh_trang">
          <option value="">â€” Táº¥t cáº£ â€”</option>
          {% for st in STATUS_CHOICES %}
            <option value="{{ st }}" {% if request.args.get('tinh_trang')==st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="grid md:grid-cols-5 gap-3">
      <div class="md:col-span-4">
        <label class="block text-sm text-gray-600 mb-1">Tá»« khoÃ¡ trong ná»™i dung</label>
        <input class="input" name="q" placeholder="vd: khiáº¿u náº¡i, cÃºp Ä‘iá»‡nâ€¦" value="{{ request.args.get('q','') }}">
      </div>
      <div class="flex items-end gap-2">
        <button class="btn btn-primary w-full" type="submit">ğŸ” TÃ¬m kiáº¿m</button>
      </div>
    </div>
  </form>
</div>

<!-- Báº£ng danh sÃ¡ch (giá»¯ nguyÃªn) -->
<div class="section" style="background:#fff6e6">
  <span class="icon" style="background:#ffedd5;color:#9a3412">ğŸ“„</span>
  Báº£ng cÃ´ng vÄƒn
</div>
<div class="card p-5">
  <div class="overflow-x-auto rounded-lg border">
    <table class="min-w-full text-sm">
      <thead class="th">
        <tr>
          <th class="text-left px-3 py-2">MÃ£</th>
          <th class="text-left px-3 py-2">ThÃ¡ng</th>
          <th class="text-left px-3 py-2">NÄƒm</th>
          <th class="text-left px-3 py-2">Loáº¡i</th>
          <th class="text-left px-3 py-2">MÃ£ KH</th>
          <th class="text-left px-3 py-2">TÃªn</th>
          <th class="text-left px-3 py-2">Äá»‹a chá»‰</th>
          <th class="text-left px-3 py-2">Ná»™i dung</th>
          <th class="text-left px-3 py-2">NhÃ¢n viÃªn</th>
          <th class="text-left px-3 py-2">NgÃ y nháº­n</th>
          <th class="text-left px-3 py-2">TÃ¬nh tráº¡ng</th>
          {% if current_user.role == 'admin' %}
          <th class="text-right px-3 py-2">HÃ nh Ä‘á»™ng</th>
          {% endif %}
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for r in items %}
        <tr class="odd:bg-white even:bg-gray-50">
          <td class="px-3 py-2 font-semibold">
            <a href="{{ url_for('congvan_detail', id=r.id) }}" class="text-[var(--pri)] hover:underline">{{ r.ma }}</a>
          </td>
          <td class="px-3 py-2">{{ r.thang }}</td>
          <td class="px-3 py-2">{{ r.nam }}</td>
          <td class="px-3 py-2">{{ r.loai_don_thu }}</td>
          <td class="px-3 py-2">{{ r.ma_kh }}</td>
          <td class="px-3 py-2">{{ r.ten }}</td>
          <td class="px-3 py-2">{{ r.dia_chi }}</td>
          <td class="px-3 py-2 truncate max-w-[16rem]" title="{{ r.noi_dung }}">{{ r.noi_dung }}</td>
          <td class="px-3 py-2">{{ r.nhan_vien }}</td>
          <td class="px-3 py-2">{{ r.ngay_nv_nhan.strftime('%d/%m/%Y') if r.ngay_nv_nhan }}</td>
          <td class="px-3 py-2">
            {% if r.tinh_trang == 'NV chÆ°a láº¥y Ä‘Æ¡n' %}
              <span class="chip chip-amber">NV chÆ°a láº¥y</span>
            {% elif r.tinh_trang == 'Äang giáº£i quyáº¿t' %}
              <span class="chip chip-blue">Äang giáº£i quyáº¿t</span>
            {% elif r.tinh_trang == 'PKD tráº£ vá» NV' %}
              <span class="chip chip-rose">PKD tráº£ vá»</span>
            {% else %}
              <span class="chip chip-teal">HoÃ n thÃ nh</span>
            {% endif %}
          </td>
          {% if current_user.role == 'admin' %}
          <td class="px-3 py-2">
            <div class="flex justify-end gap-2">
              <a class="btn btn-ghost" href="{{ url_for('congvan_edit', id=r.id) }}">Sá»­a</a>
              <form method="post" action="{{ url_for('congvan_delete', id=r.id) }}" onsubmit="return confirm('XoÃ¡ cÃ´ng vÄƒn nÃ y?')">
                <button class="btn btn-ghost" type="submit">XoÃ¡</button>
              </form>
            </div>
          </td>
          {% endif %}
        </tr>
        {% else %}
        <tr><td class="px-3 py-2" colspan="{{ 12 if current_user.role == 'admin' else 11 }}">KhÃ´ng cÃ³ dá»¯ liá»‡u.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if pager.pages > 1 %}
  <div class="mt-4 flex items-center justify-between text-sm">
    <div>Trang {{ pager.page }} / {{ pager.pages }} Â· {{ pager.total }} báº£n ghi</div>
    <div class="flex gap-2">
      {% if pager.has_prev %}<a class="btn btn-ghost" href="{{ page_url(pager.prev_num) }}">Â« TrÆ°á»›c</a>{% endif %}
      {% if pager.has_next %}<a class="btn btn-ghost" href="{{ page_url(pager.next_num) }}">Sau Â»</a>{% endif %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
