{% extends "base.html" %}
{% block content %}

<!-- THẺ NHANH -->
<div class="grid md:grid-cols-3 gap-4 mb-6">
  <div class="card p-4">
    <div class="text-sm text-gray-500">Đang giải quyết</div>
    <div class="text-2xl heading">{{ dang_giai_quyet|length }}</div>
  </div>
  <div class="card p-4">
    <div class="text-sm text-gray-500">NV chưa lấy đơn</div>
    <div class="text-2xl heading">{{ chua_lay|length }}</div>
  </div>
  <div class="card p-4">
    <div class="text-sm text-gray-500">Tháng hoàn thành gần nhất</div>
    <div class="text-2xl heading">{% if latest_thang and latest_nam %}{{ '%02d'|format(latest_thang) }}/{{ latest_nam }}{% else %}—{% endif %}</div>
  </div>
</div>

<!-- HOÀN THÀNH THEO LOẠI (THÁNG GẦN NHẤT) -->
<div class="card p-6 mb-6">
  <div class="flex items-center justify-between mb-2">
    <h2 class="text-lg heading">Hoàn thành theo Loại đơn thư</h2>
    <div class="text-sm text-gray-600">
      {% if latest_thang and latest_nam %}Tháng {{ '%02d'|format(latest_thang) }}/{{ latest_nam }}{% else %}Chưa có dữ liệu{% endif %}
    </div>
  </div>
  <div class="overflow-x-auto rounded-lg border">
    <table class="min-w-full text-sm">
      <thead class="th">
        <tr>
          <th class="text-left px-3 py-2">Loại đơn thư</th>
          <th class="text-right px-3 py-2">Số lượng</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% if hoan_thanh_by_loai %}
          {% for loai, cnt in hoan_thanh_by_loai %}
          <tr class="odd:bg-white even:bg-gray-50">
            <td class="px-3 py-2">{{ loai }}</td>
            <td class="px-3 py-2 text-right font-semibold">{{ cnt }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td class="px-3 py-2" colspan="2">Không có dữ liệu.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- BỘ LỌC TÌM KIẾM — bố cục 2 hàng gọn gàng -->
<div class="card p-6 mb-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg heading">Tìm kiếm công văn</h2>
    <a class="btn btn-ghost" href="{{ url_for('dashboard') }}">Làm mới</a>
  </div>

  <form method="get" action="{{ url_for('dashboard') }}" class="space-y-3">
    <!-- Hàng 1 -->
    <div class="grid md:grid-cols-4 gap-3">
      <div>
        <label class="block text-sm text-gray-600 mb-1">Mã</label>
        <input class="input" name="ma" value="{{ request.args.get('ma','') }}" />
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Tên</label>
        <input class="input" name="ten" value="{{ request.args.get('ten','') }}" />
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Địa chỉ</label>
        <input class="input" name="dia_chi" value="{{ request.args.get('dia_chi','') }}" />
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Loại đơn thư</label>
        <select class="select" name="loai">
          <option value="">— Tất cả —</option>
          <option value="__EMPTY__" {% if request.args.get('loai')=='__EMPTY__' %}selected{% endif %}>(Trống)</option>
          {% for opt in loai_options %}
            <option value="{{ opt }}" {% if request.args.get('loai')==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Hàng 2 -->
    <div class="grid md:grid-cols-4 gap-3">
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-600 mb-1">Từ khoá trong nội dung</label>
        <input class="input" name="q" placeholder="vd: khiếu nại, cấp sổ..." value="{{ request.args.get('q','') }}" />
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Tháng</label>
        <input class="input" name="thang" type="number" min="1" max="12" value="{{ request.args.get('thang','') }}" />
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Năm</label>
        <input class="input" name="nam" type="number" value="{{ request.args.get('nam','') }}" />
      </div>
    </div>

    <div class="grid md:grid-cols-4 gap-3">
      <div>
        <label class="block text-sm text-gray-600 mb-1">Tình trạng</label>
        <select class="select" name="tinh_trang">
          <option value="">— Tất cả —</option>
          {% for st in STATUS_CHOICES %}
            <option value="{{ st }}" {% if request.args.get('tinh_trang')==st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="md:col-span-3 flex items-end gap-2">
        <button class="btn btn-primary" type="submit">Tìm kiếm</button>
        <a class="btn btn-ghost"
           href="{{ url_for('export_excel') }}{% if request.query_string %}?{{ request.query_string.decode() }}{% endif %}">
          Xuất Excel
        </a>
      </div>
    </div>
  </form>

  <!-- Chips hiển thị bộ lọc -->
  <div class="mt-4 flex flex-wrap gap-2 text-sm text-gray-600">
    {% if request.args.get('ma') %}<span class="chip">Mã: {{ request.args.get('ma') }}</span>{% endif %}
    {% if request.args.get('ten') %}<span class="chip">Tên: {{ request.args.get('ten') }}</span>{% endif %}
    {% if request.args.get('dia_chi') %}<span class="chip">ĐC: {{ request.args.get('dia_chi') }}</span>{% endif %}
    {% if request.args.get('loai') %}<span class="chip">Loại: {{ request.args.get('loai') }}</span>{% endif %}
    {% if request.args.get('q') %}<span class="chip">Nội dung: {{ request.args.get('q') }}</span>{% endif %}
    {% if request.args.get('thang') %}<span class="chip">Tháng: {{ request.args.get('thang') }}</span>{% endif %}
    {% if request.args.get('nam') %}<span class="chip">Năm: {{ request.args.get('nam') }}</span>{% endif %}
    {% if request.args.get('tinh_trang') %}<span class="chip">TT: {{ request.args.get('tinh_trang') }}</span>{% endif %}
  </div>
</div>

<!-- DANH SÁCH -->
<div class="card p-6">
  <div class="overflow-x-auto rounded-lg border">
    <table class="min-w-full text-sm">
      <thead class="th">
        <tr>
          <th class="text-left px-3 py-2">Mã</th>
          <th class="text-left px-3 py-2">Loại</th>
          <th class="text-left px-3 py-2">Tháng/Năm</th>
          <th class="text-left px-3 py-2">Mã KH</th>
          <th class="text-left px-3 py-2">Tên</th>
          <th class="text-left px-3 py-2">Địa chỉ</th>
          <th class="text-left px-3 py-2">Nhân viên</th>
          <th class="text-left px-3 py-2">Tình trạng</th>
          {% if current_user.role == 'admin' %}
            <th class="text-right px-3 py-2">Hành động</th>
          {% endif %}
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for r in items %}
        <tr class="odd:bg-white even:bg-gray-50">
          <td class="px-3 py-2 font-semibold">
            <a href="{{ url_for('congvan_detail', id=r.id) }}" class="text-[var(--primary)] hover:underline">{{ r.ma }}</a>
          </td>
          <td class="px-3 py-2">{{ r.loai_don_thu }}</td>
          <td class="px-3 py-2">{{ r.thang or '' }}/{{ r.nam or '' }}</td>
          <td class="px-3 py-2">{{ r.ma_kh }}</td>
          <td class="px-3 py-2">{{ r.ten }}</td>
          <td class="px-3 py-2">{{ r.dia_chi }}</td>
          <td class="px-3 py-2">{{ r.nhan_vien }}</td>
          <td class="px-3 py-2">{{ r.tinh_trang }}</td>
          {% if current_user.role == 'admin' %}
          <td class="px-3 py-2">
            <div class="flex justify-end gap-2">
              <a class="btn btn-ghost" href="{{ url_for('congvan_edit', id=r.id) }}">Sửa</a>
              <form method="post" action="{{ url_for('congvan_delete', id=r.id) }}" onsubmit="return confirm('Xoá công văn này?')">
                <button class="btn btn-ghost" type="submit">Xoá</button>
              </form>
            </div>
          </td>
          {% endif %}
        </tr>
        {% else %}
        <tr><td class="px-3 py-2" colspan="{{ 9 if current_user.role == 'admin' else 8 }}">Không có dữ liệu.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if pager.pages > 1 %}
    <div class="mt-4 flex items-center justify-between text-sm">
      <div>Trang {{ pager.page }} / {{ pager.pages }} · {{ pager.total }} bản ghi</div>
      <div class="flex gap-2">
        {% if pager.has_prev %}
          <a class="btn btn-ghost" href="{{ page_url(pager.prev_num) }}">« Trước</a>
        {% endif %}
        {% if pager.has_next %}
          <a class="btn btn-ghost" href="{{ page_url(pager.next_num) }}">Sau »</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}
