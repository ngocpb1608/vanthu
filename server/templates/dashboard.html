{% extends "base.html" %}
{% block content %}

<!-- ===== TH·ªêNG K√ä (x·∫øp d·ªçc: NV ch∆∞a l·∫•y -> ƒêang gi·∫£i quy·∫øt) ===== -->
<div class="card" style="margin-bottom:14px">
  <h3 class="heading">Th·ªëng k√™</h3>

  <!-- NV CH∆ØA L·∫§Y -->
  <div class="stat-card stat-blue" style="margin-bottom:12px">
    <div class="stat-title">NV ch∆∞a l·∫•y ‚Äî chi ti·∫øt ({{ chua_lay|length }} h·ªì s∆°)</div>
    <div class="list">
      <table>
        <thead>
          <tr>
            <th>M√£ KH</th><th>Lo·∫°i</th><th>T√™n KH</th><th>ƒê·ªãa ch·ªâ</th><th>N·ªôi dung</th><th>Nh√¢n vi√™n</th>
          </tr>
        </thead>
        <tbody>
          {% if chua_lay %}
            {% for r in chua_lay %}
              <tr>
                <td><a href="{{ url_for('congvan_detail', id=r.id) }}">{{ r.ma_kh or ('#' ~ r.id) }}</a></td>
                <td>{{ r.loai_don_thu or '' }}</td>
                <td>{{ r.ten or '' }}</td>
                <td>{{ r.dia_chi or '' }}</td>
                <td>{{ (r.noi_dung or '')[:120] }}</td>
                <td>{{ r.nhan_vien or '' }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ƒêANG GI·∫¢I QUY·∫æT -->
  <div class="stat-card stat-amber">
    <div class="stat-title">ƒêang gi·∫£i quy·∫øt ‚Äî chi ti·∫øt ({{ dang_giai_quyet|length }} h·ªì s∆°)</div>
    <div class="list">
      <table>
        <thead>
          <tr>
            <th>M√£ KH</th><th>Lo·∫°i</th><th>T√™n KH</th><th>ƒê·ªãa ch·ªâ</th><th>N·ªôi dung</th><th>Nh√¢n vi√™n</th>
          </tr>
        </thead>
        <tbody>
          {% if dang_giai_quyet %}
            {% for r in dang_giai_quyet %}
              <tr>
                <td><a href="{{ url_for('congvan_detail', id=r.id) }}">{{ r.ma_kh or ('#' ~ r.id) }}</a></td>
                <td>{{ r.loai_don_thu or '' }}</td>
                <td>{{ r.ten or '' }}</td>
                <td>{{ r.dia_chi or '' }}</td>
                <td>{{ (r.noi_dung or '')[:120] }}</td>
                <td>{{ r.nhan_vien or '' }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ho√†n th√†nh theo lo·∫°i (th√°ng g·∫ßn nh·∫•t) -->
  <div class="card" style="margin-top:12px;background:#fafcff">
    <div class="stat-title">
      Ho√†n th√†nh theo Lo·∫°i ƒë∆°n th∆∞ ‚Äî
      {% if latest_thang and latest_nam %}
        Th√°ng {{ "%02d"|format(latest_thang) }}/{{ latest_nam }}
        <span class="chip" style="margin-left:8px">{{ month_completed }}/{{ month_total }} ƒë√£ ho√†n th√†nh</span>
      {% else %}
        <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
      {% endif %}
    </div>
    <table>
      <thead><tr><th>Lo·∫°i ƒë∆°n th∆∞</th><th>S·ªë l∆∞·ª£ng</th></tr></thead>
      <tbody>
        {% if hoan_thanh_by_loai %}
          {% for loai, cnt in hoan_thanh_by_loai %}
            <tr><td>{{ loai }}</td><td>{{ cnt }}</td></tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="2" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===== T√åM KI·∫æM ===== -->
<div class="card">
  <h3 class="heading">T√¨m ki·∫øm c√¥ng vƒÉn</h3>
  <form method="get" class="row cols-6">
    <input name="ten" class="ipt" placeholder="T√™n KH" value="{{ request.args.get('ten','') }}">
    <input name="ma_kh" class="ipt" placeholder="M√£ KH" value="{{ request.args.get('ma_kh','') }}">
    <input name="dia_chi" class="ipt" placeholder="ƒê·ªãa ch·ªâ" value="{{ request.args.get('dia_chi','') }}">
    <select name="loai" class="ipt">
      <option value="">Lo·∫°i ƒë∆°n th∆∞</option>
      {% for lo in loai_options %}
        <option value="{{ lo }}" {% if request.args.get('loai')==lo %}selected{% endif %}>{{ lo }}</option>
      {% endfor %}
      <option value="__EMPTY__" {% if request.args.get('loai')=='__EMPTY__' %}selected{% endif %}>(kh√¥ng ghi)</option>
    </select>
    <input name="thang" class="ipt" placeholder="Th√°ng" value="{{ request.args.get('thang','') }}">
    <input name="nam" class="ipt" placeholder="NƒÉm" value="{{ request.args.get('nam','') }}">

    <input name="q" class="ipt" placeholder="T·ª´ kho√° trong n·ªôi dung" value="{{ request.args.get('q','') }}" style="grid-column:span 5">
    <select name="tinh_trang" class="ipt">
      <option value="">T√¨nh tr·∫°ng</option>
      {% for s in STATUS_CHOICES %}
        <option value="{{ s }}" {% if request.args.get('tinh_trang')==s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>

    <div style="grid-column:span 6;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn brand" type="submit">üîç T√¨m ki·∫øm</button>
      <a class="btn" href="{{ url_for('dashboard') }}">L√†m m·ªõi</a>
    </div>
  </form>

  <!-- Xu·∫•t Excel ƒë√∫ng theo k·∫øt qu·∫£ hi·ªán t·∫°i -->
  <form method="get" action="{{ url_for('export_table') }}" style="margin-top:8px">
    {% for k,v in request.args.items() %}
      <input type="hidden" name="{{ k }}" value="{{ v }}">
    {% endfor %}
    <button class="btn" type="submit">‚¨áÔ∏è Xu·∫•t Excel (k·∫øt qu·∫£ hi·ªán t·∫°i)</button>
  </form>
</div>

<!-- ===== B·∫¢NG CHI TI·∫æT (ch·ªâ admin) ===== -->
{% if current_user.role == 'admin' %}
<div class="card" style="margin-top:14px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">
    <h3 class="heading">B·∫£ng c√¥ng vƒÉn</h3>
    <form method="get" action="{{ url_for('export_table') }}">
      {% for k,v in request.args.items() %}
        <input type="hidden" name="{{ k }}" value="{{ v }}">
      {% endfor %}
      <button class="btn" type="submit">‚¨áÔ∏è Xu·∫•t Excel (k·∫øt qu·∫£ hi·ªán t·∫°i)</button>
    </form>
  </div>

  <div style="overflow:auto; max-height:60vh; border:1px solid var(--ring); border-radius:12px">
    <table id="main-table">
      <thead>
        <tr>
          <th>STT</th><th>Th√°ng</th><th>NƒÉm</th><th>Lo·∫°i</th>
          <th>M√£ KH</th><th>T√™n</th><th>ƒê·ªãa ch·ªâ</th><th>N·ªôi dung</th>
          <th>Nh√¢n vi√™n</th><th>Ng√†y nh·∫≠n</th><th>T√¨nh tr·∫°ng</th><th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        {% for r in items %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.thang or '' }}</td>
          <td>{{ r.nam or '' }}</td>
          <td>{{ r.loai_don_thu or '' }}</td>
          <td style="white-space:nowrap"><a href="{{ url_for('congvan_detail', id=r.id) }}">{{ r.ma_kh or ('#' ~ r.id) }}</a></td>
          <td>{{ r.ten or '' }}</td>
          <td>{{ r.dia_chi or '' }}</td>
          <td>{{ r.noi_dung or '' }}</td>
          <td>{{ r.nhan_vien or '' }}</td>
          <td>{{ r.ngay_nv_nhan or '' }}</td>
          <td>{{ r.tinh_trang or '' }}</td>
          <td>
            <a class="btn small" href="{{ url_for('congvan_edit', id=r.id) }}">S·ª≠a</a>
            <form method="post" action="{{ url_for('congvan_delete', id=r.id) }}" style="display:inline" onsubmit="return confirm('Xo√° c√¥ng vƒÉn?')">
              <button class="btn small" type="submit">Xo√°</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="12" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {% if pager and pager.pages > 1 %}
  <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
    {% if pager.has_prev %}<a class="btn" href="{{ page_url(pager.prev_num) }}">¬´ Tr∆∞·ªõc</a>{% endif %}
    <span class="chip">Trang {{ pager.page }}/{{ pager.pages }}</span>
    {% if pager.has_next %}<a class="btn" href="{{ page_url(pager.next_num) }}">Sau ¬ª</a>{% endif %}
  </div>
  {% endif %}
</div>
{% endif %}

{% endblock %}
