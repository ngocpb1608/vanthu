{% extends "base.html" %}
{% block content %}

<!-- THỐNG KÊ NHANH (có màu) -->
<div class="stats">
  <div class="stat blue">
    <h4>NV chưa lấy — chi tiết</h4>
    <div class="num">{{ chua_lay|length }}</div>
    {% if chua_lay %}
    <div class="list">
      <table>
        <thead><tr><th>Mã</th><th>Loại</th><th>Tên KH</th><th>Địa chỉ</th><th>Nội dung</th><th>NV</th></tr></thead>
        <tbody>
        {% for r in chua_lay[:10] %}
          <tr>
            <td><a href="{{ url_for('congvan_detail', id=r.id) }}">{{ r.id }}</a></td>
            <td>{{ r.loai_don_thu or '' }}</td>
            <td>{{ r.ten or '' }}</td>
            <td>{{ r.dia_chi or '' }}</td>
            <td>{{ r.noi_dung or '' }}</td>
            <td>{{ r.nhan_vien or '' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>

  <div class="stat yellow">
    <h4>Đang giải quyết</h4>
    <div class="num">{{ dang_giai_quyet|length }}</div>
  </div>

  <div class="stat green">
    <h4>Hoàn thành theo Loại (tháng gần nhất)</h4>
    {% if latest_thang and latest_nam %}
      <div class="pill" style="margin-top:6px">Tháng {{ latest_thang }} / {{ latest_nam }}</div>
    {% endif %}
    <div class="list" style="margin-top:10px">
      {% if hoan_thanh_by_loai %}
        <table>
          <thead><tr><th>Loại đơn thư</th><th>Số lượng</th></tr></thead>
          <tbody>
          {% for loai,cnt in hoan_thanh_by_loai %}
            <tr><td>{{ loai }}</td><td>{{ cnt }}</td></tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div style="padding:10px;color:#0f172a">Không có dữ liệu.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- TÌM KIẾM -->
<div class="card" style="margin-top:14px">
  <h3 style="margin:0 0 8px 0">Tìm kiếm công văn</h3>
  <form method="get" style="display:grid;gap:8px;grid-template-columns:repeat(6,minmax(0,1fr))">
    <input name="ten" placeholder="Tên KH" value="{{ request.args.get('ten','') }}" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">
    <input name="ma_kh" placeholder="Mã KH" value="{{ request.args.get('ma_kh','') }}" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">
    <input name="dia_chi" placeholder="Địa chỉ" value="{{ request.args.get('dia_chi','') }}" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">
    <select name="loai" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">
      <option value="">Loại đơn thư</option>
      {% for lo in loai_options %}
        <option value="{{ lo }}" {% if request.args.get('loai')==lo %}selected{% endif %}>{{ lo }}</option>
      {% endfor %}
      <option value="__EMPTY__" {% if request.args.get('loai')=='__EMPTY__' %}selected{% endif %}>(không ghi)</option>
    </select>
    <input name="thang" placeholder="Tháng" value="{{ request.args.get('thang','') }}" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">
    <input name="nam" placeholder="Năm" value="{{ request.args.get('nam','') }}" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">
    <input name="q" placeholder="Từ khoá trong nội dung" value="{{ request.args.get('q','') }}" style="grid-column:span 5;padding:8px;border:1px solid #e5e7eb;border-radius:8px">
    <select name="tinh_trang" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px">
      <option value="">Tình trạng</option>
      {% for s in STATUS_CHOICES if s != 'PKD trả về NV' %}
        <option value="{{ s }}" {% if request.args.get('tinh_trang')==s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    <div style="grid-column:span 6;display:flex;gap:8px">
      <button class="btn brand" type="submit">Tìm kiếm</button>
      <a class="btn" href="{{ url_for('dashboard') }}">Làm mới</a>
    </div>
  </form>
</div>

<!-- BẢNG DỮ LIỆU -->
<div class="card" style="margin-top:14px">
  <h3 style="margin:0 0 8px 0">Bảng công văn</h3>
  <div style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>STT</th><th>Tháng</th><th>Năm</th><th>Loại</th><th>Mã KH</th><th>Tên</th><th>Địa chỉ</th><th>Nội dung</th><th>Nhân viên</th><th>Ngày nhận</th><th>Tình trạng</th>
          {% if current_user.role == 'admin' %}<th>Hành động</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for r in items %}
        <tr>
          <td><a href="{{ url_for('congvan_detail', id=r.id) }}">{{ r.id }}</a></td>
          <td>{{ r.thang or '' }}</td>
          <td>{{ r.nam or '' }}</td>
          <td>{{ r.loai_don_thu or '' }}</td>
          <td>{{ r.ma_kh or '' }}</td>
          <td>{{ r.ten or '' }}</td>
          <td>{{ r.dia_chi or '' }}</td>
          <td>{{ r.noi_dung or '' }}</td>
          <td>{{ r.nhan_vien or '' }}</td>
          <td>{{ r.ngay_nv_nhan or '' }}</td>
          <td>
            {% set t = (r.tinh_trang or '') %}
            <span class="pill {% if 'Hoàn' in t %}ok{% elif 'Đang' in t %}warn{% elif 'PKD' in t %}bad{% endif %}">{{ t }}</span>
          </td>
          {% if current_user.role == 'admin' %}
          <td>
            <a class="btn" href="{{ url_for('congvan_edit', id=r.id) }}">Sửa</a>
            <form method="post" action="{{ url_for('congvan_delete', id=r.id) }}" style="display:inline" onsubmit="return confirm('Xoá công văn?')">
              <button class="btn" type="submit">Xoá</button>
            </form>
          </td>
          {% endif %}
        </tr>
        {% else %}
        <tr><td colspan="12" style="color:#64748b">Không có dữ liệu.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if pager and pager.pages > 1 %}
  <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
    {% if pager.has_prev %}<a class="btn" href="{{ page_url(pager.prev_num) }}">« Trước</a>{% endif %}
    <span class="pill">Trang {{ pager.page }}/{{ pager.pages }}</span>
    {% if pager.has_next %}<a class="btn" href="{{ page_url(pager.next_num) }}">Sau »</a>{% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
