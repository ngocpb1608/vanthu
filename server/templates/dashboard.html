{% extends "base.html" %}
{% block content %}

<div class="space-y-6"><!-- B·ªçc to√†n trang ƒë·ªÉ tr√°nh l·ªìng kh·ªëi -->

  <!-- === TH·ªêNG K√ä TR·∫†NG TH√ÅI (tr√™n c√πng) === -->
  <div>
    <div class="section" style="background:#e8faf7">
      <span class="icon" style="background:#d1fae5;color:#065f46">üìä</span>
      Th·ªëng k√™ theo t√¨nh tr·∫°ng
    </div>

    <!-- 2 th·∫ª t·ªïng quan -->
    <div class="grid md:grid-cols-2 gap-4">
      <div class="stat stat-teal">
        <div class="font-extrabold mb-1">NV ch∆∞a l·∫•y</div>
        <div class="text-sm text-gray-600">{{ chua_lay|length }} h·ªì s∆°</div>
      </div>
      <div class="stat stat-amber">
        <div class="font-extrabold mb-1">ƒêang gi·∫£i quy·∫øt</div>
        <div class="text-sm text-gray-600">{{ dang_giai_quyet|length }} h·ªì s∆°</div>
      </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt NV ch∆∞a l·∫•y -->
    <div class="card p-5 mt-4">
      <div class="mb-3 flex items-center justify-between">
        <h3 class="text-lg heading">NV ch∆∞a l·∫•y ‚Äî chi ti·∫øt</h3>
        <div class="text-sm text-gray-600">T·ªïng {{ chua_lay|length }} h·ªì s∆°</div>
      </div>

      <div class="overflow-x-auto rounded-lg border max-h-[28rem] overflow-y-auto">
        <table class="min-w-full text-sm">
          <thead class="th">
            <tr>
              <th class="text-left px-3 py-2">M√£</th>
              <th class="text-left px-3 py-2">Lo·∫°i ƒë∆°n th∆∞</th>
              <th class="text-left px-3 py-2">T√™n KH</th>
              <th class="text-left px-3 py-2">ƒê·ªãa ch·ªâ</th>
              <th class="text-left px-3 py-2">N·ªôi dung</th>
              <th class="text-left px-3 py-2">Nh√¢n vi√™n</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            {% for r in chua_lay %}
            <tr class="odd:bg-white even:bg-gray-50">
              <td class="px-3 py-2 font-semibold">
                <a href="{{ url_for('congvan_detail', id=r.id) }}" class="text-[var(--pri)] hover:underline">{{ r.ma }}</a>
              </td>
              <td class="px-3 py-2">{{ r.loai_don_thu }}</td>
              <td class="px-3 py-2">{{ r.ten }}</td>
              <td class="px-3 py-2">{{ r.dia_chi }}</td>
              <td class="px-3 py-2 truncate max-w-[22rem]" title="{{ r.noi_dung }}">{{ r.noi_dung }}</td>
              <td class="px-3 py-2">{{ r.nhan_vien }}</td>
            </tr>
            {% else %}
            <tr><td class="px-3 py-2" colspan="6">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- === HO√ÄN TH√ÄNH THEO LO·∫†I (th√°ng g·∫ßn nh·∫•t) === -->
  <div>
    <div class="section">
      <span class="icon">üóÇÔ∏è</span> Ho√†n th√†nh theo Lo·∫°i ƒë∆°n th∆∞
    </div>
    <div class="card p-5">
      <div class="mb-3 text-sm text-gray-600">
        {% if latest_thang and latest_nam %}
          Th√°ng {{ '%02d'|format(latest_thang) }}/{{ latest_nam }}
        {% else %}
          Ch∆∞a c√≥ d·ªØ li·ªáu
        {% endif %}
      </div>
      <div class="overflow-x-auto rounded-lg border">
        <table class="min-w-full text-sm">
          <thead class="th">
            <tr>
              <th class="text-left px-3 py-2">Lo·∫°i ƒë∆°n th∆∞</th>
              <th class="text-right px-3 py-2">S·ªë l∆∞·ª£ng</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            {% if hoan_thanh_by_loai %}
              {% for loai, cnt in hoan_thanh_by_loai %}
              <tr class="odd:bg-white even:bg-gray-50">
                <td class="px-3 py-2">{{ loai }}</td>
                <td class="px-3 py-2 text-right font-semibold">{{ cnt }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td class="px-3 py-2" colspan="2">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- === T√åM KI·∫æM === -->
  <div>
    <div class="section"><span class="icon">üîé</span> T√¨m ki·∫øm c√¥ng vƒÉn</div>
    <div class="card p-5">
      <form method="get" action="{{ url_for('dashboard') }}" class="space-y-3">
        <div class="grid md:grid-cols-5 gap-3">
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-600 mb-1">T√™n KH</label>
            <input class="input" name="ten" placeholder="Nh·∫≠p t√™n..." value="{{ request.args.get('ten','') }}">
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">M√£ KH</label>
            <input class="input" name="ma_kh" placeholder="Nh·∫≠p m√£..." value="{{ request.args.get('ma_kh','') }}">
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Th√°ng</label>
            <input class="input" type="number" min="1" max="12" name="thang" value="{{ request.args.get('thang','') }}">
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">NƒÉm</label>
            <input class="input" type="number" name="nam" value="{{ request.args.get('nam','') }}">
          </div>
        </div>

        <div class="grid md:grid-cols-5 gap-3">
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-600 mb-1">ƒê·ªãa ch·ªâ</label>
            <input class="input" name="dia_chi" value="{{ request.args.get('dia_chi','') }}">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-gray-600 mb-1">Lo·∫°i ƒë∆°n th∆∞</label>
            <select class="select" name="loai">
              <option value="">‚Äî T·∫•t c·∫£ ‚Äî</option>
              <option value="__EMPTY__" {% if request.args.get('loai')=='__EMPTY__' %}selected{% endif %}>(Tr·ªëng)</option>
              {% for opt in loai_options %}
                <option value="{{ opt }}" {% if request.args.get('loai')==opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">T√¨nh tr·∫°ng</label>
            <select class="select" name="tinh_trang">
              <option value="">‚Äî T·∫•t c·∫£ ‚Äî</option>
              {% for st in STATUS_CHOICES %}
                <option value="{{ st }}" {% if request.args.get('tinh_trang')==st %}selected{% endif %}>{{ st }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="grid md:grid-cols-5 gap-3">
          <div class="md:col-span-4">
            <label class="block text-sm text-gray-600 mb-1">T·ª´ kho√° trong n·ªôi dung</label>
            <input class="input" name="q" placeholder="vd: khi·∫øu n·∫°i, c√∫p ƒëi·ªán‚Ä¶" value="{{ request.args.get('q','') }}">
          </div>
          <div class="flex items-end gap-2">
            <button class="btn btn-primary w-full" type="submit">üîé T√¨m ki·∫øm</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- === B·∫¢NG DANH S√ÅCH === -->
  <div>
    <div class="section" style="background:#fff6e6">
      <span class="icon" style="background:#ffedd5;color:#9a3412">üìÑ</span>
      B·∫£ng c√¥ng vƒÉn
    </div>
    <div class="card p-5">
      <div class="overflow-x-auto rounded-lg border">
        <table class="min-w-full text-sm">
          <thead class="th">
            <tr>
              <th class="text-left px-3 py-2">M√£</th>
              <th class="text-left px-3 py-2">Th√°ng</th>
              <th class="text-left px-3 py-2">NƒÉm</th>
              <th class="text-left px-3 py-2">Lo·∫°i</th>
              <th class="text-left px-3 py-2">M√£ KH</th>
              <th class="text-left px-3 py-2">T√™n</th>
              <th class="text-left px-3 py-2">ƒê·ªãa ch·ªâ</th>
              <th class="text-left px-3 py-2">N·ªôi dung</th>
              <th class="text-left px-3 py-2">Nh√¢n vi√™n</th>
              <th class="text-left px-3 py-2">Ng√†y nh·∫≠n</th>
              <th class="text-left px-3 py-2">T√¨nh tr·∫°ng</th>
              {% if current_user.role == 'admin' %}
              <th class="text-right px-3 py-2">H√†nh ƒë·ªông</th>
              {% endif %}
            </tr>
          </thead>
          <tbody class="divide-y">
            {% for r in items %}
            <tr class="odd:bg-white even:bg-gray-50">
              <td class="px-3 py-2 font-semibold">
                <a href="{{ url_for('congvan_detail', id=r.id) }}" class="text-[var(--pri)] hover:underline">{{ r.ma }}</a>
              </td>
              <td class="px-3 py-2">{{ r.thang }}</td>
              <td class="px-3 py-2">{{ r.nam }}</td>
              <td class="px-3 py-2">{{ r.loai_don_thu }}</td>
              <td class="px-3 py-2">{{ r.ma_kh }}</td>
              <td class="px-3 py-2">{{ r.ten }}</td>
              <td class="px-3 py-2">{{ r.dia_chi }}</td>
              <td class="px-3 py-2 truncate max-w-[16rem]" title="{{ r.noi_dung }}">{{ r.noi_dung }}</td>
              <td class="px-3 py-2">{{ r.nhan_vien }}</td>
              <td class="px-3 py-2">{{ r.ngay_nv_nhan.strftime('%d/%m/%Y') if r.ngay_nv_nhan }}</td>
              <td class="px-3 py-2">
                {% if r.tinh_trang == 'NV ch∆∞a l·∫•y ƒë∆°n' %}
                  <span class="chip chip-amber">NV ch∆∞a l·∫•y</span>
                {% elif r.tinh_trang == 'ƒêang gi·∫£i quy·∫øt' %}
                  <span class="chip chip-blue">ƒêang gi·∫£i quy·∫øt</span>
                {% elif r.tinh_trang == 'PKD tr·∫£ v·ªÅ NV' %}
                  <span class="chip chip-rose">PKD tr·∫£ v·ªÅ</span>
                {% else %}
                  <span class="chip chip-teal">Ho√†n th√†nh</span>
                {% endif %}
              </td>
              {% if current_user.role == 'admin' %}
              <td class="px-3 py-2">
                <div class="flex justify-end gap-2">
                  <a class="btn btn-ghost" href="{{ url_for('congvan_edit', id=r.id) }}">S·ª≠a</a>
                  <form method="post" action="{{ url_for('congvan_delete', id=r.id) }}" onsubmit="return confirm('Xo√° c√¥ng vƒÉn n√†y?')">
                    <button class="btn btn-ghost" type="submit">Xo√°</button>
                  </form>
                </div>
              </td>
              {% endif %}
            </tr>
            {% else %}
            <tr><td class="px-3 py-2" colspan="{{ 12 if current_user.role == 'admin' else 11 }}">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      {% if pager.pages > 1 %}
      <div class="mt-4 flex items-center justify-between text-sm">
        <div>Trang {{ pager.page }} / {{ pager.pages }} ¬∑ {{ pager.total }} b·∫£n ghi</div>
        <div class="flex gap-2">
          {% if pager.has_prev %}<a class="btn btn-ghost" href="{{ page_url(pager.prev_num) }}">¬´ Tr∆∞·ªõc</a>{% endif %}
          {% if pager.has_next %}<a class="btn btn-ghost" href="{{ page_url(pager.next_num) }}">Sau ¬ª</a>{% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

</div><!-- /space-y-6 -->

{% endblock %}
