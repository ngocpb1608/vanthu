{% extends "base.html" %}
{% block content %}

<style>
  .list.open{ max-height:70vh !important; }
  .card-tools{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
</style>

<!-- ===== TH·ªêNG K√ä ===== -->
<div class="card" style="margin-bottom:14px">
  <h3 class="heading">Th·ªëng k√™</h3>

  <div class="stats">
    <!-- NV CH∆ØA L·∫§Y ‚Äî CHI TI·∫æT -->
    <div class="stat-card stat-blue">
      <div class="stat-title">NV ch∆∞a l·∫•y ‚Äî chi ti·∫øt</div>
      <div class="num">{{ chua_lay|length }}</div>

      {% if chua_lay %}
      <div id="list-chualay" class="list">
        <table>
          <thead>
            <tr>
              <th style="white-space:nowrap">M√£ KH</th>
              <th>Lo·∫°i</th><th>T√™n</th><th>ƒê·ªãa ch·ªâ</th><th>N·ªôi dung</th><th>NV</th>
            </tr>
          </thead>
          <tbody>
            {% for r in chua_lay %}
            <tr>
              <td style="white-space:nowrap">
                <a href="{{ url_for('congvan_detail', id=r.id) }}">{{ r.ma_kh or ('#' ~ r.id) }}</a>
              </td>
              <td>{{ r.loai_don_thu or '' }}</td>
              <td>{{ r.ten or '' }}</td>
              <td>{{ r.dia_chi or '' }}</td>
              <td style="max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ r.noi_dung or '' }}</td>
              <td>{{ r.nhan_vien or '' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-tools">
        {% if chua_lay|length > 12 %}
          <button class="btn small" type="button" onclick="toggleList('list-chualay', this)" data-label="Xem t·∫•t c·∫£ ({{ chua_lay|length }})">
            Xem t·∫•t c·∫£ ({{ chua_lay|length }})
          </button>
        {% endif %}
        <a class="btn small" href="{{ url_for('dashboard', tinh_trang='NV ch∆∞a l·∫•y ƒë∆°n') }}">L·ªçc nh√≥m n√†y</a>
        <form method="get" action="{{ url_for('export_table') }}">
          <input type="hidden" name="tinh_trang" value="NV ch∆∞a l·∫•y ƒë∆°n">
          <button class="btn small" type="submit">‚¨áÔ∏è Xu·∫•t Excel nh√≥m n√†y</button>
        </form>
      </div>
      {% endif %}
    </div>

    <!-- ƒêANG GI·∫¢I QUY·∫æT ‚Äî CHI TI·∫æT -->
    <div class="stat-card stat-amber">
      <div class="stat-title">ƒêang gi·∫£i quy·∫øt ‚Äî chi ti·∫øt</div>
      <div class="num">{{ dang_giai_quyet|length }}</div>

      {% if dang_giai_quyet %}
      <div id="list-danggq" class="list">
        <table>
          <thead>
            <tr>
              <th style="white-space:nowrap">M√£ KH</th>
              <th>Lo·∫°i</th><th>T√™n</th><th>ƒê·ªãa ch·ªâ</th><th>N·ªôi dung</th><th>NV</th>
            </tr>
          </thead>
          <tbody>
            {% for r in dang_giai_quyet %}
            <tr>
              <td style="white-space:nowrap">
                <a href="{{ url_for('congvan_detail', id=r.id) }}">{{ r.ma_kh or ('#' ~ r.id) }}</a>
              </td>
              <td>{{ r.loai_don_thu or '' }}</td>
              <td>{{ r.ten or '' }}</td>
              <td>{{ r.dia_chi or '' }}</td>
              <td style="max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ r.noi_dung or '' }}</td>
              <td>{{ r.nhan_vien or '' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-tools">
        {% if dang_giai_quyet|length > 12 %}
          <button class="btn small" type="button" onclick="toggleList('list-danggq', this)" data-label="Xem t·∫•t c·∫£ ({{ dang_giai_quyet|length }})">
            Xem t·∫•t c·∫£ ({{ dang_giai_quyet|length }})
          </button>
        {% endif %}
        <a class="btn small" href="{{ url_for('dashboard', tinh_trang='ƒêang gi·∫£i quy·∫øt') }}">L·ªçc nh√≥m n√†y</a>
        <form method="get" action="{{ url_for('export_table') }}">
          <input type="hidden" name="tinh_trang" value="ƒêang gi·∫£i quy·∫øt">
          <button class="btn small" type="submit">‚¨áÔ∏è Xu·∫•t Excel nh√≥m n√†y</button>
        </form>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Ho√†n th√†nh theo lo·∫°i -->
  <div class="card" style="margin-top:12px;background:#fafcff">
    <div class="stat-title" style="margin-bottom:6px">Ho√†n th√†nh theo Lo·∫°i (th√°ng g·∫ßn nh·∫•t)</div>
    {% if latest_thang and latest_nam %}
      <div class="chip" style="margin:6px 0">
        Th√°ng {{ latest_thang }}/{{ latest_nam }}
        {% if month_total %}
          ¬∑ Ho√†n th√†nh <b>{{ month_completed }}</b> / T·ªïng <b>{{ month_total }}</b>
          {% if month_total>0 %} ({{ ((month_completed/month_total)*100)|round(1) }}%){% endif %}
        {% endif %}
      </div>
    {% endif %}
    <div style="display:grid;gap:8px">
      {% if hoan_thanh_by_loai %}
        {% for loai,cnt in hoan_thanh_by_loai %}
          <div class="chip" style="display:flex;justify-content:space-between;gap:12px">
            <span><b>{{ loai or 'Kh√¥ng r√µ' }}</b> ‚Äî s·ªë l∆∞·ª£ng:</span>
            <span><b>{{ cnt }}</b></span>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ===== T√åM KI·∫æM ===== -->
<div class="card">
  <h3 class="heading">T√¨m ki·∫øm c√¥ng vƒÉn</h3>
  <form method="get" class="row cols-6">
    <input name="ten" class="ipt" placeholder="T√™n KH" value="{{ request.args.get('ten','') }}">
    <input name="ma_kh" class="ipt" placeholder="M√£ KH" value="{{ request.args.get('ma_kh','') }}">
    <input name="dia_chi" class="ipt" placeholder="ƒê·ªãa ch·ªâ" value="{{ request.args.get('dia_chi','') }}">
    <select name="loai" class="ipt">
      <option value="">Lo·∫°i ƒë∆°n th∆∞</option>
      {% for lo in loai_options %}
        <option value="{{ lo }}" {% if request.args.get('loai')==lo %}selected{% endif %}>{{ lo }}</option>
      {% endfor %}
      <option value="__EMPTY__" {% if request.args.get('loai')=='__EMPTY__' %}selected{% endif %}>(kh√¥ng ghi)</option>
    </select>
    <input name="thang" class="ipt" placeholder="Th√°ng" value="{{ request.args.get('thang','') }}">
    <input name="nam" class="ipt" placeholder="NƒÉm" value="{{ request.args.get('nam','') }}">

    <input name="q" class="ipt" placeholder="T·ª´ kho√° trong n·ªôi dung" value="{{ request.args.get('q','') }}" style="grid-column:span 5">
    <select name="tinh_trang" class="ipt">
      <option value="">T√¨nh tr·∫°ng</option>
      {% for s in STATUS_CHOICES %}
        <option value="{{ s }}" {% if request.args.get('tinh_trang')==s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>

    <div style="grid-column:span 6;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn brand" type="submit">üîç T√¨m ki·∫øm</button>
      <a class="btn" href="{{ url_for('dashboard') }}">L√†m m·ªõi</a>
    </div>
  </form>

  <!-- Form GET RI√äNG ƒë·ªÉ Xu·∫•t Excel theo k·∫øt qu·∫£ t√¨m ki·∫øm -->
  <form method="get" action="{{ url_for('export_table') }}" style="margin-top:8px">
    {% for k,v in request.args.items() %}
      <input type="hidden" name="{{ k }}" value="{{ v }}">
    {% endfor %}
    <button class="btn" type="submit">‚¨áÔ∏è Xu·∫•t Excel (k·∫øt qu·∫£ hi·ªán t·∫°i)</button>
  </form>
</div>

<!-- ===== B·∫¢NG CHI TI·∫æT (ch·ªâ admin) ===== -->
{% if current_user.role == 'admin' %}
<div class="card" style="margin-top:14px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">
    <h3 class="heading">B·∫£ng c√¥ng vƒÉn</h3>
    <form method="get" action="{{ url_for('export_table') }}">
      {% for k,v in request.args.items() %}
        <input type="hidden" name="{{ k }}" value="{{ v }}">
      {% endfor %}
      <button class="btn" type="submit">‚¨áÔ∏è Xu·∫•t Excel (k·∫øt qu·∫£ hi·ªán t·∫°i)</button>
    </form>
  </div>

  <div style="overflow:auto; max-height:60vh; border:1px solid var(--ring); border-radius:12px">
    <table id="main-table">
      <thead>
        <tr>
          <th>STT</th><th>Th√°ng</th><th>NƒÉm</th><th>Lo·∫°i</th>
          <th>M√£ KH</th><th>T√™n</th><th>ƒê·ªãa ch·ªâ</th><th>N·ªôi dung</th>
          <th>Nh√¢n vi√™n</th><th>Ng√†y nh·∫≠n</th><th>T√¨nh tr·∫°ng</th><th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        {% for r in items %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.thang or '' }}</td>
          <td>{{ r.nam or '' }}</td>
          <td>{{ r.loai_don_thu or '' }}</td>
          <td style="white-space:nowrap"><a href="{{ url_for('congvan_detail', id=r.id) }}">{{ r.ma_kh or ('#' ~ r.id) }}</a></td>
          <td>{{ r.ten or '' }}</td>
          <td>{{ r.dia_chi or '' }}</td>
          <td>{{ r.noi_dung or '' }}</td>
          <td>{{ r.nhan_vien or '' }}</td>
          <td>{{ r.ngay_nv_nhan or '' }}</td>
          <td>
            {% set t = (r.tinh_trang or '') %}
            <span class="chip {% if 'Ho√†n' in t or 'hoan' in t %}ok{% elif 'ƒêang' in t or 'dang' in t %}warn{% endif %}">{{ t }}</span>
          </td>
          <td>
            <a class="btn small" href="{{ url_for('congvan_edit', id=r.id) }}">S·ª≠a</a>
            <form method="post" action="{{ url_for('congvan_delete', id=r.id) }}" style="display:inline" onsubmit="return confirm('Xo√° c√¥ng vƒÉn?')">
              <button class="btn small" type="submit">Xo√°</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="12" style="color:var(--muted)">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if pager and pager.pages > 1 %}
  <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
    {% if pager.has_prev %}<a class="btn" href="{{ page_url(pager.prev_num) }}">¬´ Tr∆∞·ªõc</a>{% endif %}
    <span class="chip">Trang {{ pager.page }}/{{ pager.pages }}</span>
    {% if pager.has_next %}<a class="btn" href="{{ page_url(pager.next_num) }}">Sau ¬ª</a>{% endif %}
  </div>
  {% endif %}
</div>
{% endif %}

<script>
  function toggleList(id, btn){
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('open');
    const opened = el.classList.contains('open');
    const base = btn.dataset.label || 'Xem t·∫•t c·∫£';
    btn.textContent = opened ? 'Thu g·ªçn' : base;
  }
</script>

{% endblock %}
